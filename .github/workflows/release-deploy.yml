name: Release & Deploy

on:
  workflow_run:
    workflows: ["Docker Scan & Promote"]
    types: [completed]
  workflow_dispatch:
    inputs:
      skip_deploy:
        description: 'Skip deployment (release only)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io

jobs:
  release:
    name: Create CalVer Release
    if: >
      (github.event_name == 'workflow_dispatch' && github.ref_name == 'main') ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      version: ${{ steps.calver.outputs.version }}
      sha: ${{ steps.sha.outputs.sha }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine SHA
        id: sha
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SHA="${{ github.sha }}"
          else
            SHA="${{ github.event.workflow_run.head_sha }}"
          fi
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "short-sha=${SHA::7}" >> $GITHUB_OUTPUT
          echo "owner=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

      - name: Compute CalVer tag
        id: calver
        run: |
          YEAR=$(date +%Y)
          MONTH=$(date +%-m)
          PATTERN="^${YEAR}\\.${MONTH}\\.[0-9]+$"
          git fetch --tags

          HIGHEST=$(git tag -l | grep -E "$PATTERN" | \
            awk -F. '{print $3}' | sort -n | tail -1)

          if [ -z "$HIGHEST" ]; then
            PATCH=0
          else
            PATCH=$((HIGHEST + 1))
          fi

          VERSION="${YEAR}.${MONTH}.${PATCH}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install crane
        uses: imjasonh/setup-crane@v0.5

      - name: Tag images with CalVer version
        run: |
          PREFIX="${GITHUB_REPOSITORY_OWNER,,}/integr8scode"
          VERSION="${{ steps.calver.outputs.version }}"
          for img in base backend frontend cert-generator; do
            crane copy "$REGISTRY/$PREFIX/$img:latest" "$REGISTRY/$PREFIX/$img:$VERSION"
          done

      - name: Create Git tag
        run: |
          VERSION="${{ steps.calver.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.calver.outputs.version }}
          name: ${{ steps.calver.outputs.version }}
          generate_release_notes: true
          body: |
            **Commit**: `${{ steps.sha.outputs.short-sha }}`

            ### Docker Images

            ```
            docker pull ghcr.io/${{ steps.sha.outputs.owner }}/integr8scode/backend:${{ steps.calver.outputs.version }}
            docker pull ghcr.io/${{ steps.sha.outputs.owner }}/integr8scode/frontend:${{ steps.calver.outputs.version }}
            ```

  deploy:
    name: Deploy to Production
    needs: [release]
    if: >
      (github.event_name == 'workflow_run') ||
      (github.event_name == 'workflow_dispatch' && !inputs.skip_deploy)
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        env:
          GHCR_TOKEN: ${{ secrets.DEPLOY_GHCR_TOKEN }}
          GHCR_USER: ${{ github.repository_owner }}
          IMAGE_TAG: ${{ needs.release.outputs.version }}
          GRAFANA_ADMIN_USER: ${{ secrets.GRAFANA_ADMIN_USER }}
          GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
          MAILJET_API_KEY: ${{ secrets.MAILJET_API_KEY }}
          MAILJET_SECRET_KEY: ${{ secrets.MAILJET_SECRET_KEY }}
          MAILJET_FROM_ADDRESS: ${{ secrets.MAILJET_FROM_ADDRESS }}
          MAILJET_HOST: ${{ secrets.MAILJET_HOST }}
          GRAFANA_ALERT_RECIPIENTS: ${{ secrets.GRAFANA_ALERT_RECIPIENTS }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          envs: GHCR_TOKEN,GHCR_USER,IMAGE_TAG,GRAFANA_ADMIN_USER,GRAFANA_ADMIN_PASSWORD,MAILJET_API_KEY,MAILJET_SECRET_KEY,MAILJET_FROM_ADDRESS,MAILJET_HOST,GRAFANA_ALERT_RECIPIENTS
          command_timeout: 10m
          script: |
            set -e
            cd /opt/Integr8sCode

            git pull origin main

            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin

            export IMAGE_TAG="$IMAGE_TAG"
            export COMPOSE_PROFILES=observability
            export GRAFANA_ROOT_URL="https://grafana.integr8scode.cc/"
            export GRAFANA_ADMIN_USER="$GRAFANA_ADMIN_USER"
            export GRAFANA_ADMIN_PASSWORD="$GRAFANA_ADMIN_PASSWORD"
            export MAILJET_API_KEY="$MAILJET_API_KEY"
            export MAILJET_SECRET_KEY="$MAILJET_SECRET_KEY"
            export MAILJET_FROM_ADDRESS="$MAILJET_FROM_ADDRESS"
            export GF_SMTP_HOST="$MAILJET_HOST"
            export GRAFANA_ALERT_RECIPIENTS="$GRAFANA_ALERT_RECIPIENTS"
            docker compose pull
            docker compose up -d --remove-orphans --no-build --wait --wait-timeout 180

            curl -sf -X POST \
              -u "$GRAFANA_ADMIN_USER:$GRAFANA_ADMIN_PASSWORD" \
              http://localhost:3000/api/admin/provisioning/dashboards/reload

            echo "Backend healthy (IMAGE_TAG=$IMAGE_TAG)"

            docker image prune -af --filter "until=72h" || true

  summary:
    name: Summary
    needs: [release, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## Release & Deploy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.release.result }}" = "success" ]; then
            echo "- Release **${{ needs.release.outputs.version }}** created" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Release: **${{ needs.release.result }}**" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "- Deployed to production" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Deploy: **${{ needs.deploy.result }}**" >> $GITHUB_STEP_SUMMARY
          fi
