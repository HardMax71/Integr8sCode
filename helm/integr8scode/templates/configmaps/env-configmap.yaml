apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "integr8scode.fullname" . }}-env
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "integr8scode.labels" . | nindent 4 }}
data:
  # ==========================================================================
  # CRITICAL: Explicit port settings to override K8s auto-generated env vars
  # K8s auto-creates SERVICE_PORT variables in tcp://IP:PORT format which
  # conflicts with application expectations of integer port numbers.
  # ==========================================================================
  REDIS_HOST: {{ include "integr8scode.redisHost" . | quote }}
  REDIS_PORT: "6379"
  REDIS_DB: {{ .Values.env.REDIS_DB | default "0" | quote }}

  # Kafka configuration
  KAFKA_BOOTSTRAP_SERVERS: {{ include "integr8scode.kafkaBootstrapServers" . | quote }}
  SCHEMA_REGISTRY_URL: {{ include "integr8scode.schemaRegistryUrl" . | quote }}

  # MongoDB
  MONGODB_URL: {{ include "integr8scode.mongodbUrl" . | quote }}

  # Kubernetes
  K8S_NAMESPACE: {{ .Release.Namespace | quote }}

  # Application settings
  PROJECT_NAME: {{ .Values.env.PROJECT_NAME | default "integr8scode" | quote }}
  API_V1_STR: {{ .Values.env.API_V1_STR | default "/api/v1" | quote }}
  LOG_LEVEL: {{ .Values.env.LOG_LEVEL | default "INFO" | quote }}
  SERVICE_NAME: {{ .Values.env.SERVICE_NAME | default "integr8scode-backend" | quote }}
  SERVICE_VERSION: {{ .Values.env.SERVICE_VERSION | default .Chart.AppVersion | quote }}

  # Server configuration
  SERVER_HOST: "0.0.0.0"
  SERVER_PORT: "443"

  # Event streaming
  ENABLE_EVENT_STREAMING: {{ .Values.env.ENABLE_EVENT_STREAMING | default "true" | quote }}
  EVENT_RETENTION_DAYS: {{ .Values.env.EVENT_RETENTION_DAYS | default "30" | quote }}

  # Tracing
  ENABLE_TRACING: {{ .Values.env.ENABLE_TRACING | default "false" | quote }}
  {{- if .Values.infrastructure.jaeger.enabled }}
  JAEGER_AGENT_HOST: {{ include "integr8scode.jaegerHost" . | quote }}
  JAEGER_AGENT_PORT: "6831"
  {{- end }}
  TRACING_SAMPLING_RATE: {{ .Values.env.TRACING_SAMPLING_RATE | default "0.1" | quote }}

  # DLQ configuration
  DLQ_RETRY_MAX_ATTEMPTS: {{ .Values.env.DLQ_RETRY_MAX_ATTEMPTS | default "5" | quote }}
  DLQ_RETENTION_DAYS: {{ .Values.env.DLQ_RETENTION_DAYS | default "7" | quote }}

  # Rate limiting
  RATE_LIMIT_ENABLED: {{ .Values.env.RATE_LIMIT_ENABLED | default "true" | quote }}
  RATE_LIMIT_DEFAULT_REQUESTS: {{ .Values.env.RATE_LIMIT_DEFAULT_REQUESTS | default "100" | quote }}
  RATE_LIMIT_DEFAULT_WINDOW: {{ .Values.env.RATE_LIMIT_DEFAULT_WINDOW | default "60" | quote }}

  # WebSocket / SSE
  WEBSOCKET_PING_INTERVAL: {{ .Values.env.WEBSOCKET_PING_INTERVAL | default "30" | quote }}
  WEBSOCKET_PING_TIMEOUT: {{ .Values.env.WEBSOCKET_PING_TIMEOUT | default "10" | quote }}
  SSE_CONSUMER_POOL_SIZE: {{ .Values.env.SSE_CONSUMER_POOL_SIZE | default "10" | quote }}
  SSE_HEARTBEAT_INTERVAL: {{ .Values.env.SSE_HEARTBEAT_INTERVAL | default "30" | quote }}
